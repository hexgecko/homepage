!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.loki=e()}(this,function(){return function(){"use strict";function t(t,e,i){var n,r;if(!t||!e||t===!0||e===!0){if(!(t!==!0&&t!==!1||e!==!0&&e!==!1))return i?t===e:t?!1:e;if(void 0===e||null===e||t===!0||e===!1)return i;if(void 0===t||null===t||t===!1||e===!0)return!0}return t===e?i:e>t?!0:t>e?!1:(n=t.toString(),r=e.toString(),n==r?i:r>n?!0:!1)}function e(t,e,i){var n,r;if(!t||!e||t===!0||e===!0){if(!(t!==!0&&t!==!1||e!==!0&&e!==!1))return i?t===e:t?!e:!1;if(void 0===t||null===t||t===!1||e===!0)return i;if(void 0===e||null===e||t===!0||e===!1)return!0}return t===e?i:t>e?!0:e>t?!1:(n=t.toString(),r=e.toString(),n==r?i:n>r?!0:!1)}function i(i,n,r){return i===n?0:t(i,n,!1)?r?1:-1:e(i,n,!1)?r?-1:1:0}function n(t,e,n){for(var r,s,o=0,a=0,l=t.length;l>a;a++)if(r=t[a],s=r[0],o=i(e[s],n[s],r[1]),0!==o)return o;return 0}function r(t,e,i,n){for(var s=null,o=0,a=0,l=null,h=0,u=e.length;u>h;h++){if(s=e[h],void 0===t||null===t||!$.call(t,s))return!1;if(Array.isArray(t)){if(a=t.length,u>h+1){for(l=e.slice(h+1),o=0;a>o;o++)if(r(t[o],l,i,n))return!0}else for(o=0;a>o;o++)if(i(t[o][s],n))return!0;return!1}t=t[s]}return i(t,n)}function s(t){return"string"==typeof t||Array.isArray(t)?function(e){return-1!==t.indexOf(e)}:"object"==typeof t?function(e){return $.call(t,e)}:null}function o(t,e){for(var i in e)if($.call(e,i))return S[i](t,e[i]);return!1}function a(t,e){var i,n=e||"parse-stringify";switch(n){case"parse-stringify":i=JSON.parse(JSON.stringify(t));break;case"jquery-extend-deep":i=jQuery.extend(!0,{},t);break;case"shallow":i=Object.create(t.prototype||null),Object.keys(t).map(function(e){i[e]=t[e]})}return i}function l(t,e){var i,n=[];if("parse-stringify"==e)return a(t,e);for(i=t.length-1;0>=i;i--)n.push(a(t[i],e));return n}function h(){try{return window&&void 0!==window.localStorage&&null!==window.localStorage}catch(t){return!1}}function u(){}function c(t,e){this.filename=t||"loki.db",this.collections=[],this.databaseVersion=1.1,this.engineVersion=1.1,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.verbose=e&&e.hasOwnProperty("verbose")?e.verbose:!1,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};var i=function(){if("undefined"!=typeof global&&(global.android||global.NSObject)){if(!e.adapter){var t=require("./loki-nativescript-adapter");e.adapter=new t}return"NATIVESCRIPT"}return"undefined"==typeof window?"NODEJS":"undefined"!=typeof global&&global.window?"NODEJS":"undefined"!=typeof document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA"};this.ENV=e&&e.hasOwnProperty("env")?e.env:i(),"undefined"===this.ENV&&(this.ENV="NODEJS"),this.configureOptions(e,!0),this.on("init",this.clearChanges)}function f(){this.fs=require("fs")}function p(){}function d(t,e){return e=e||{},e.queryObj=e.queryObj||null,e.queryFunc=e.queryFunc||null,e.firstOnly=e.firstOnly||!1,this.collection=t,this.searchIsChained=!e.queryObj&&!e.queryFunc,this.filteredrows=[],this.filterInitialized=!1,"undefined"!=typeof e.queryObj&&null!==e.queryObj?this.find(e.queryObj,e.firstOnly):"undefined"!=typeof e.queryFunc&&null!==e.queryFunc?this.where(e.queryFunc):this}function y(t,e,i){this.collection=t,this.name=e,this.rebuildPending=!1,this.options=i||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.options.hasOwnProperty("minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new d(t),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1,this.events={rebuild:[]}}function v(t,e){function i(t){var e="function"==typeof Set?new Set:[];e.add||(e.add=function(t){return-1===this.indexOf(t)&&this.push(t),this}),t.forEach(function(t){e.add(t.object)}),e.forEach(function(t){if(!$.call(t,"$loki"))return f.removeAutoUpdateObserver(t);try{f.update(t)}catch(e){}})}function n(t,e,i){f.changes.push({name:t,operation:e,obj:JSON.parse(JSON.stringify(i))})}function r(){f.changes=[]}function s(t){t&&(t.meta||(t.meta={}),t.meta.created=(new Date).getTime(),t.meta.revision=0)}function o(t){t&&(t.meta.updated=(new Date).getTime(),t.meta.revision+=1)}function a(t){n(f.name,"I",t)}function l(t){n(f.name,"U",t)}function h(t){s(t),a(t)}function u(t){o(t),l(t)}function c(){y=f.disableChangesApi?s:h,v=f.disableChangesApi?o:u}this.name=t,this.data=[],this.idIndex=[],this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=t,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var f=this;e=e||{},e.hasOwnProperty("unique")&&(Array.isArray(e.unique)||(e.unique=[e.unique]),e.unique.forEach(function(t){f.uniqueNames.push(t),f.constraints.unique[t]=new q(t)})),e.hasOwnProperty("exact")&&e.exact.forEach(function(t){f.constraints.exact[t]=new P(t)}),this.transactional=e.hasOwnProperty("transactional")?e.transactional:!1,this.cloneObjects=e.hasOwnProperty("clone")?e.clone:!1,this.cloneMethod=e.hasOwnProperty("cloneMethod")?e.cloneMethod:"parse-stringify",this.asyncListeners=e.hasOwnProperty("asyncListeners")?e.asyncListeners:!1,this.disableChangesApi=e.hasOwnProperty("disableChangesApi")?e.disableChangesApi:!0,this.autoupdate=e.hasOwnProperty("autoupdate")?e.autoupdate:!1,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(e.ttl||-1,e.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],"delete":[],warning:[]},this.changes=[],this.ensureId();var p=[];if(e&&e.indices)if("[object Array]"===Object.prototype.toString.call(e.indices))p=e.indices;else{if("string"!=typeof e.indices)throw new TypeError("Indices needs to be a string or an array of strings");p=[e.indices]}for(var d=0;d<p.length;d++)this.ensureIndex(p[d]);this.observerCallback=i,this.getChanges=function(){return f.changes},this.flushChanges=r;var y,v;c(),this.setChangesApi=function(t){f.disableChangesApi=!t,c()},this.on("insert",function(t){y(t)}),this.on("update",function(t){v(t)}),this.on("delete",function(t){f.disableChangesApi||n(f.name,"R",t)}),this.on("warning",function(t){f.console.warn(t)}),r()}function g(t){return-1!==t.indexOf(".")}function m(t){return parseFloat(t,10)}function w(t,e){return t+e}function b(t,e){return t-e}function I(t){return t.reduce(w,0)/t.length}function O(t){var e=I(t),i=t.map(function(t){var i=t-e,n=i*i;return n}),n=I(i),r=Math.sqrt(n);return r}function x(t,e,i){if(i===!1)return t[e];for(var n=e.split("."),r=t;n.length>0;)r=r[n.shift()];return r}function D(t,e,i){for(var n,r,s=0,o=t.length;o>s;){if(r=s+o>>1,n=i.apply(null,[e,t[r]]),0===n)return{found:!0,index:r};0>n?o=r:s=r+1}return{found:!1,index:o}}function k(t){return function(e,i){return D(e,i,t)}}function A(){}function q(t){this.field=t,this.keyMap={},this.lokiMap={}}function P(t){this.index={},this.field=t}function C(t){this.field=t}var $=Object.prototype.hasOwnProperty,E={copyProperties:function(t,e){var i;for(i in t)e[i]=t[i]},resolveTransformObject:function(t,e,i){var n,r;if("number"!=typeof i&&(i=0),++i>=10)return t;for(n in t)"string"==typeof t[n]&&0===t[n].indexOf("[%lktxp]")?(r=t[n].substring(8),e.hasOwnProperty(r)&&(t[n]=e[r])):"object"==typeof t[n]&&(t[n]=E.resolveTransformObject(t[n],e,i));return t},resolveTransformParams:function(t,e){var i,n,r=[];if("undefined"==typeof e)return t;for(i=0;i<t.length;i++)n=JSON.parse(JSON.stringify(t[i])),r.push(E.resolveTransformObject(n,e));return r}},S={$eq:function(t,e){return t===e},$aeq:function(t,e){return t==e},$ne:function(t,e){return isNaN(e)?!isNaN(t):t!==e},$dteq:function(i,n){return t(i,n,!1)?!1:!e(i,n,!1)},$gt:function(t,i){return e(t,i,!1)},$gte:function(t,i){return e(t,i,!0)},$lt:function(e,i){return t(e,i,!1)},$lte:function(e,i){return t(e,i,!0)},$in:function(t,e){return-1!==e.indexOf(t)},$nin:function(t,e){return-1===e.indexOf(t)},$keyin:function(t,e){return t in e},$nkeyin:function(t,e){return!(t in e)},$definedin:function(t,e){return void 0!==e[t]},$undefinedin:function(t,e){return void 0===e[t]},$regex:function(t,e){return e.test(t)},$containsString:function(t,e){return"string"==typeof t&&-1!==t.indexOf(e)},$containsNone:function(t,e){return!S.$containsAny(t,e)},$containsAny:function(t,e){var i=s(t);return null!==i?Array.isArray(e)?e.some(i):i(e):!1},$contains:function(t,e){var i=s(t);return null!==i?Array.isArray(e)?e.every(i):i(e):!1},$type:function(t,e){var i=typeof t;return"object"===i&&(Array.isArray(t)?i="array":t instanceof Date&&(i="date")),"object"!=typeof e?i===e:o(i,e)},$size:function(t,e){return Array.isArray(t)?"object"!=typeof e?t.length===e:o(t.length,e):!1},$len:function(t,e){return"string"==typeof t?"object"!=typeof e?t.length===e:o(t.length,e):!1},$where:function(t,e){return e(t)===!0},$not:function(t,e){return!o(t,e)},$and:function(t,e){for(var i=0,n=e.length;n>i;i+=1)if(!o(t,e[i]))return!1;return!0},$or:function(t,e){for(var i=0,n=e.length;n>i;i+=1)if(o(t,e[i]))return!0;return!1}},j=["$eq","$aeq","$dteq","$gt","$gte","$lt","$lte"];return u.prototype.events={},u.prototype.asyncListeners=!1,u.prototype.on=function(t,e){var i=this.events[t];return i||(i=this.events[t]=[]),i.push(e),e},u.prototype.emit=function(t,e){var i=this;if(!t||!this.events[t])throw new Error("No event "+t+" defined");this.events[t].forEach(function(t){i.asyncListeners?setTimeout(function(){t(e)},1):t(e)})},u.prototype.removeListener=function(t,e){if(this.events[t]){var i=this.events[t];i.splice(i.indexOf(e),1)}},c.prototype=new u,c.prototype.getIndexedAdapter=function(){var t;return"function"==typeof require&&(t=require("./loki-indexed-adapter.js")),t},c.prototype.configureOptions=function(t,e){var i={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage"},n={fs:f,localStorage:p};if(this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,"undefined"!=typeof t){if(this.options=t,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof n[t.persistenceMethod]&&(this.persistenceMethod=t.persistenceMethod,this.persistenceAdapter=new n[t.persistenceMethod]),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=t.adapter,this.options.adapter=null),t.autoload&&e){var r=this;setTimeout(function(){r.loadDatabase(t,t.autoloadCallback)},1)}this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.options.hasOwnProperty("autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,this.options.hasOwnProperty("autosaveCallback")?this.autosaveEnable(t,t.autosaveCallback):this.autosaveEnable())}null===this.persistenceAdapter&&(this.persistenceMethod=i[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new n[this.persistenceMethod]))},c.prototype.anonym=function(t,e){var i=new v("anonym",e);return i.insert(t),this.verbose&&(i.console=console),i},c.prototype.addCollection=function(t,e){var i=new v(t,e);return this.collections.push(i),this.verbose&&(i.console=console),i},c.prototype.loadCollection=function(t){if(!t.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(t)},c.prototype.getCollection=function(t){var e,i=this.collections.length;for(e=0;i>e;e+=1)if(this.collections[e].name===t)return this.collections[e];return this.emit("warning","collection "+t+" not found"),null},c.prototype.listCollections=function(){for(var t=this.collections.length,e=[];t--;)e.push({name:this.collections[t].name,type:this.collections[t].objType,count:this.collections[t].data.length});return e},c.prototype.removeCollection=function(t){var e,i=this.collections.length;for(e=0;i>e;e+=1)if(this.collections[e].name===t){var n=new v(t,{}),r=this.collections[e];for(var s in r)r.hasOwnProperty(s)&&n.hasOwnProperty(s)&&(r[s]=n[s]);return void this.collections.splice(e,1)}},c.prototype.getName=function(){return this.name},c.prototype.serializeReplacer=function(t,e){switch(t){case"autosaveHandle":case"persistenceAdapter":case"constraints":return null;default:return e}},c.prototype.serialize=function(){return JSON.stringify(this,this.serializeReplacer)},c.prototype.toJson=c.prototype.serialize,c.prototype.loadJSON=function(t,e){var i;i=0===t.length?{}:JSON.parse(t),this.loadJSONObject(i,e)},c.prototype.loadJSONObject=function(t,e){var i,n,r,s,o=0,a=t.collections?t.collections.length:0;for(this.name=t.name,this.databaseVersion=1,t.hasOwnProperty("databaseVersion")&&(this.databaseVersion=t.databaseVersion),this.collections=[],o;a>o;o+=1){if(i=t.collections[o],n=this.addCollection(i.name),n.transactional=i.transactional,n.asyncListeners=i.asyncListeners,n.disableChangesApi=i.disableChangesApi,n.cloneObjects=i.cloneObjects,n.cloneMethod=i.cloneMethod||"parse-stringify",n.autoupdate=i.autoupdate,r=i.data.length,s=0,e&&e.hasOwnProperty(i.name)){var l=e[i.name].inflate?e[i.name].inflate:E.copyProperties;for(s;r>s;s++){var h=new e[i.name].proto;l(i.data[s],h),n.data[s]=h,n.addAutoUpdateObserver(h)}}else for(s;r>s;s++)n.data[s]=i.data[s],n.addAutoUpdateObserver(n.data[s]);if(n.maxId=0===i.data.length?0:i.maxId,n.idIndex=i.idIndex,"undefined"!=typeof i.binaryIndices&&(n.binaryIndices=i.binaryIndices),"undefined"!=typeof i.transforms&&(n.transforms=i.transforms),n.ensureId(),n.uniqueNames=[],i.hasOwnProperty("uniqueNames"))for(n.uniqueNames=i.uniqueNames,s=0;s<n.uniqueNames.length;s++)n.ensureUniqueIndex(n.uniqueNames[s]);if("undefined"!=typeof i.DynamicViews)for(var u=0;u<i.DynamicViews.length;u++){var c=i.DynamicViews[u],f=n.addDynamicView(c.name,c.options);f.resultdata=c.resultdata,f.resultsdirty=c.resultsdirty,f.filterPipeline=c.filterPipeline,f.sortCriteria=c.sortCriteria,f.sortFunction=null,f.sortDirty=c.sortDirty,f.resultset.filteredrows=c.resultset.filteredrows,f.resultset.searchIsChained=c.resultset.searchIsChained,f.resultset.filterInitialized=c.resultset.filterInitialized,f.rematerialize({removeWhereFilters:!0})}}},c.prototype.close=function(t){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(this.saveDatabase(t),t=void 0)),t&&this.on("close",t),this.emit("close")},c.prototype.generateChangesNotification=function(t){function e(t){return t.name}var i=[],n=t||this.collections.map(e);return this.collections.forEach(function(t){-1!==n.indexOf(e(t))&&(i=i.concat(t.getChanges()))}),i},c.prototype.serializeChanges=function(t){return JSON.stringify(this.generateChangesNotification(t))},c.prototype.clearChanges=function(){this.collections.forEach(function(t){t.flushChanges&&t.flushChanges()})},f.prototype.loadDatabase=function(t,e){this.fs.readFile(t,{encoding:"utf8"},function(t,i){e(t?new Error(t):i)})},f.prototype.saveDatabase=function(t,e,i){this.fs.writeFile(t,e,i)},f.prototype.deleteDatabase=function(t,e){this.fs.unlink(t,function(t){t?e(new Error(t)):e()})},p.prototype.loadDatabase=function(t,e){e(h()?localStorage.getItem(t):new Error("localStorage is not available"))},p.prototype.saveDatabase=function(t,e,i){h()?(localStorage.setItem(t,e),i(null)):i(new Error("localStorage is not available"))},p.prototype.deleteDatabase=function(t,e){h()?(localStorage.removeItem(t),e(null)):e(new Error("localStorage is not available"))},c.prototype.loadDatabase=function(t,e){var i=e||function(t){if(t)throw t},n=this;null!==this.persistenceAdapter?this.persistenceAdapter.loadDatabase(this.filename,function(e){if("string"==typeof e){var r=!1;try{n.loadJSON(e,t||{}),r=!0}catch(s){i(s)}r&&(i(null),n.emit("loaded","database "+n.filename+" loaded"))}else"object"!=typeof e||null===e||e instanceof Error?i(e):(n.loadJSONObject(e,t||{}),i(null),n.emit("loaded","database "+n.filename+" loaded"))}):i(new Error("persistenceAdapter not configured"))},c.prototype.saveDatabase=function(t){var e=t||function(t){if(t)throw t},i=this;null!==this.persistenceAdapter?"reference"===this.persistenceAdapter.mode&&"function"==typeof this.persistenceAdapter.exportDatabase?this.persistenceAdapter.exportDatabase(this.filename,this,function(t){i.autosaveClearFlags(),e(t)}):this.persistenceAdapter.saveDatabase(this.filename,i.serialize(),function(t){i.autosaveClearFlags(),e(t)}):e(new Error("persistenceAdapter not configured"))},c.prototype.save=c.prototype.saveDatabase,c.prototype.deleteDatabase=function(t,e){var i=e||function(t){if(t)throw t};null!==this.persistenceAdapter?this.persistenceAdapter.deleteDatabase(this.filename,function(t){i(t)}):i(new Error("persistenceAdapter not configured"))},c.prototype.autosaveDirty=function(){for(var t=0;t<this.collections.length;t++)if(this.collections[t].dirty)return!0;return!1},c.prototype.autosaveClearFlags=function(){for(var t=0;t<this.collections.length;t++)this.collections[t].dirty=!1},c.prototype.autosaveEnable=function(t,e){this.autosave=!0;var i=5e3,n=this;"undefined"!=typeof this.autosaveInterval&&null!==this.autosaveInterval&&(i=this.autosaveInterval),this.autosaveHandle=setInterval(function(){n.autosaveDirty()&&n.saveDatabase(e)},i)},c.prototype.autosaveDisable=function(){"undefined"!=typeof this.autosaveHandle&&null!==this.autosaveHandle&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)},d.prototype.reset=function(){return this.filteredrows.length>0&&(this.filteredrows=[]),this.filterInitialized=!1,this},d.prototype.toJSON=function(){var t=this.copy();return t.collection=null,t},d.prototype.limit=function(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var e=new d(this.collection);return e.filteredrows=this.filteredrows.slice(0,t),e.filterInitialized=!0,e},d.prototype.offset=function(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var e=new d(this.collection);return e.filteredrows=this.filteredrows.slice(t),e.filterInitialized=!0,e},d.prototype.copy=function(){var t=new d(this.collection);return this.filteredrows.length>0&&(t.filteredrows=this.filteredrows.slice()),t.filterInitialized=this.filterInitialized,t},d.prototype.branch=d.prototype.copy,d.prototype.transform=function(t,e){var i,n,r=this;if("string"==typeof t&&this.collection.transforms.hasOwnProperty(t)&&(t=this.collection.transforms[t]),"object"!=typeof t||!Array.isArray(t))throw new Error("Invalid transform");for("undefined"!=typeof e&&(t=E.resolveTransformParams(t,e)),i=0;i<t.length;i++)switch(n=t[i],n.type){case"find":r.find(n.value);break;case"where":r.where(n.value);break;case"simplesort":r.simplesort(n.property,n.desc);break;case"compoundsort":r.compoundsort(n.value);break;case"sort":r.sort(n.value);break;case"limit":r=r.limit(n.value);break;case"offset":r=r.offset(n.value);break;case"map":r=r.map(n.value);break;case"eqJoin":r=r.eqJoin(n.joinData,n.leftJoinKey,n.rightJoinKey,n.mapFun);break;case"mapReduce":r=r.mapReduce(n.mapFunction,n.reduceFunction);break;case"update":r.update(n.value);break;case"remove":r.remove()}return r},d.prototype.sort=function(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var e=function(t,e){return function(i,n){return t(e[i],e[n])}}(t,this.collection.data);return this.filteredrows.sort(e),this},d.prototype.simplesort=function(t,e){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex()),"undefined"==typeof e&&(e=!1);var n=function(t,e,n){return function(r,s){return i(n[r][t],n[s][t],e)}}(t,e,this.collection.data);return this.filteredrows.sort(n),this},d.prototype.compoundsort=function(t){if(0===t.length)throw new Error("Invalid call to compoundsort, need at least one property");var e;if(1===t.length)return e=t[0],Array.isArray(e)?this.simplesort(e[0],e[1]):this.simplesort(e,!1);for(var i=0,r=t.length;r>i;i+=1)e=t[i],Array.isArray(e)||(t[i]=[e,!1]);this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var s=function(t,e){return function(i,r){return n(t,e[i],e[r])}}(t,this.collection.data);return this.filteredrows.sort(s),this},d.prototype.calculateRange=function(i,n,r){var s=this.collection.data,o=this.collection.binaryIndices[n].values,a=0,l=o.length-1,h=0;if(0===s.length)return[0,-1];var u=s[o[a]][n],c=s[o[l]][n];switch(i){case"$eq":case"$aeq":if(t(r,u,!1)||e(r,c,!1))return[0,-1];break;case"$dteq":if(t(r,u,!1)||e(r,c,!1))return[0,-1];break;case"$gt":if(e(r,c,!0))return[0,-1];break;case"$gte":if(e(r,c,!1))return[0,-1];break;case"$lt":if(t(r,u,!0))return[0,-1];if(t(c,r,!1))return[0,s.length-1];break;case"$lte":if(t(r,u,!1))return[0,-1];if(t(c,r,!0))return[0,s.length-1]}for(;l>a;)h=a+l>>1,t(s[o[h]][n],r,!1)?a=h+1:l=h;var f=a;for(l=o.length-1;l>a;)h=a+l>>1,t(r,s[o[h]][n],!1)?l=h:a=h+1;var p=l,d=s[o[f]][n],y=s[o[p]][n];switch(i){case"$eq":return d!==r?[0,-1]:(y!==r&&p--,[f,p]);case"$dteq":return d>r||r>d?[0,-1]:((y>r||r>y)&&p--,[f,p]);case"$gt":return t(y,r,!0)?[0,-1]:[p,s.length-1];case"$gte":return t(d,r,!1)?[0,-1]:[f,s.length-1];case"$lt":return 0===f&&t(d,r,!1)?[0,0]:[0,f-1];case"$lte":return y!==r&&p--,0===p&&t(y,r,!1)?[0,0]:[0,p];default:return[0,s.length-1]}},d.prototype.findOr=function(t){for(var e=null,i=0,n=0,r=[],s=[],o=0,a=this.count(),l=0,h=t.length;h>l;l++){if(e=this.branch().find(t[l]).filteredrows,n=e.length,n===a)return this;for(i=0;n>i;i++)o=e[i],void 0===s[o]&&(s[o]=!0,r.push(o))}return this.filteredrows=r,this.filterInitialized=!0,this},d.prototype.$or=d.prototype.findOr,d.prototype.findAnd=function(t){for(var e=0,i=t.length;i>e;e++){if(0===this.count())return this;this.find(t[e])}return this},d.prototype.$and=d.prototype.findAnd,d.prototype.find=function(t,e){if(0===this.collection.data.length)return this.searchIsChained?(this.filteredrows=[],this.filterInitialized=!0,this):[];var i,n,s,o,a,l,h=t||"getAll",u=!1,c=[],f=null;if(e=e||!1,"object"==typeof h)for(i in h)if($.call(h,i)){n=i,s=h[i];break}if(!n||"getAll"===h)return this.searchIsChained?this:this.collection.data.slice();if("$and"===n||"$or"===n)return this.searchIsChained?(this[n](s),e&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this):(c=this.collection.chain()[n](s).data(),e?0===c.length?[]:c[0]:c);if(null===s||"object"!=typeof s||s instanceof Date)o="$eq",a=s;else{if("object"!=typeof s)throw new Error("Do not know what you want to do.");for(l in s)if($.call(s,l)){o=l,a=s[l];break}}"$regex"===o&&(Array.isArray(a)?a=new RegExp(a[0],a[1]):a instanceof RegExp||(a=new RegExp(a)));var p=-1!==n.indexOf("."),d=!(p||this.searchIsChained&&this.filterInitialized);d&&this.collection.binaryIndices[n]&&-1!==j.indexOf(o)&&(this.collection.ensureIndex(n),u=!0,f=this.collection.binaryIndices[n]);var y=S[o],v=this.collection.data,g=0;if(!this.searchIsChained){if(u){var m=this.calculateRange(o,n,a);if(e)return-1!==m[1]?v[f.values[m[0]]]:[];for(g=m[0];g<=m[1];g++)c.push(v[f.values[g]])}else{if(g=v.length,e){if(p){for(n=n.split(".");g--;)if(r(v[g],n,y,a))return v[g]}else for(;g--;)if(y(v[g][n],a))return v[g];return[]}if(p)for(n=n.split(".");g--;)r(v[g],n,y,a)&&c.push(v[g]);else for(;g--;)y(v[g][n],a)&&c.push(v[g])}return c}var w,b=0;if(this.filterInitialized)if(w=this.filteredrows,g=w.length,p)for(n=n.split(".");g--;)b=w[g],r(v[b],n,y,a)&&c.push(b);else for(;g--;)b=w[g],y(v[b][n],a)&&c.push(b);else{if(u){var I=this.calculateRange(o,n,a);for(g=I[0];g<=I[1];g++)c.push(f.values[g])}else if(g=v.length,p)for(n=n.split(".");g--;)r(v[g],n,y,a)&&c.push(g);else for(;g--;)y(v[g][n],a)&&c.push(g);this.filterInitialized=!0}return this.filteredrows=c,this},d.prototype.where=function(t){var e,i=[];if("function"!=typeof t)throw new TypeError("Argument is not a stored view or a function");e=t;try{if(this.searchIsChained){if(this.filterInitialized){for(var n=this.filteredrows.length;n--;)e(this.collection.data[this.filteredrows[n]])===!0&&i.push(this.filteredrows[n]);return this.filteredrows=i,this}for(var r=this.collection.data.length;r--;)e(this.collection.data[r])===!0&&i.push(r);return this.filteredrows=i,this.filterInitialized=!0,this}for(var s=this.collection.data.length;s--;)e(this.collection.data[s])===!0&&i.push(this.collection.data[s]);return i}catch(o){throw o}},d.prototype.count=function(){return this.searchIsChained&&this.filterInitialized?this.filteredrows.length:this.collection.count()},d.prototype.data=function(t){var e,i,n,r=[],s=this.collection.data;if(t=t||{},this.searchIsChained&&!this.filterInitialized){if(0===this.filteredrows.length){if(this.collection.cloneObjects||t.forceClones){for(e=s.length,n=t.forceCloneMethod||this.collection.cloneMethod,i=0;e>i;i++)r.push(a(s[i],n));return r}return s.slice()}this.filterInitialized=!0}var o=this.filteredrows;if(e=o.length,this.collection.cloneObjects||t.forceClones)for(n=t.forceCloneMethod||this.collection.cloneMethod,i=0;e>i;i++)r.push(a(s[o[i]],n));else for(i=0;e>i;i++)r.push(s[o[i]]);return r},d.prototype.update=function(t){if("function"!=typeof t)throw new TypeError("Argument is not a function");this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());for(var e=this.filteredrows.length,i=this.collection.data,n=0;e>n;n++)t(i[this.filteredrows[n]]),this.collection.update(i[this.filteredrows[n]]);return this},d.prototype.remove=function(){return this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.remove(this.data()),this.filteredrows=[],this},d.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(i){throw i}},d.prototype.eqJoin=function(t,e,i,n){var r,s,o,a=[],l=[],h=[],u="function"==typeof e,c="function"==typeof i,f={};if(a=this.data(),r=a.length,t instanceof d)l=t.data();else{if(!Array.isArray(t))throw new TypeError("joinData needs to be an array or result set");l=t}s=l.length;for(var p=0;s>p;p++)o=c?i(l[p]):l[p][i],f[o]=l[p];n||(n=function(t,e){return{left:t,right:e}});for(var y=0;r>y;y++)o=u?e(a[y]):a[y][e],h.push(n(a[y],f[o]||{}));return this.collection=new v("joinData"),this.collection.insert(h),this.filteredrows=[],this.filterInitialized=!1,this},d.prototype.map=function(t){var e=this.data().map(t);return this.collection=new v("mappedData"),this.collection.insert(e),this.filteredrows=[],this.filterInitialized=!1,this},y.prototype=new u,y.prototype.rematerialize=function(t){var e,i,n;if(t=t||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new d(this.collection),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0),t.hasOwnProperty("removeWhereFilters"))for(e=this.filterPipeline.length,i=e;i--;)"where"===this.filterPipeline[i].type&&(i!==this.filterPipeline.length-1&&(this.filterPipeline[i]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var r=this.filterPipeline;for(this.filterPipeline=[],e=r.length,n=0;e>n;n++)this.applyFind(r[n].val);return this.data(),this.emit("rebuild",this),this},y.prototype.branchResultset=function(t,e){var i=this.resultset.branch();return"undefined"==typeof t?i:i.transform(t,e)},y.prototype.toJSON=function(){var t=new y(this.collection,this.name,this.options);return t.resultset=this.resultset,t.resultdata=[],t.resultsdirty=!0,t.filterPipeline=this.filterPipeline,t.sortFunction=this.sortFunction,t.sortCriteria=this.sortCriteria,t.sortDirty=this.sortDirty,t.collection=null,t},y.prototype.removeFilters=function(){this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1},y.prototype.applySort=function(t){return this.sortFunction=t,this.sortCriteria=null,this.queueSortPhase(),this},y.prototype.applySimpleSort=function(t,e){return this.sortCriteria=[[t,e||!1]],this.sortFunction=null,this.queueSortPhase(),this},y.prototype.applySortCriteria=function(t){return this.sortCriteria=t,this.sortFunction=null,this.queueSortPhase(),this},y.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},y.prototype.commit=function(){return this.cachedresultset=null,this},y.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this},y.prototype._indexOfFilterWithId=function(t){if("string"==typeof t||"number"==typeof t)for(var e=0,i=this.filterPipeline.length;i>e;e+=1)if(t===this.filterPipeline[e].uid)return e;return-1},y.prototype._addFilter=function(t){this.filterPipeline.push(t),this.resultset[t.type](t.val)},y.prototype.reapplyFilters=function(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);var t=this.filterPipeline;this.filterPipeline=[];for(var e=0,i=t.length;i>e;e+=1)this._addFilter(t[e]);return this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),this},y.prototype.applyFilter=function(t){var e=this._indexOfFilterWithId(t.uid);return e>=0?(this.filterPipeline[e]=t,this.reapplyFilters()):(this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(t),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),this)},y.prototype.applyFind=function(t,e){return this.applyFilter({type:"find",val:t,uid:e}),this},y.prototype.applyWhere=function(t,e){return this.applyFilter({type:"where",val:t,uid:e}),this},y.prototype.removeFilter=function(t){var e=this._indexOfFilterWithId(t);if(0>e)throw new Error("Dynamic view does not contain a filter with ID: "+t);return this.filterPipeline.splice(e,1),this.reapplyFilters(),this},y.prototype.count=function(){return this.options.persistent?this.resultdata.length:this.resultset.count()},y.prototype.data=function(){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data()},y.prototype.queueRebuildEvent=function(){if(!this.rebuildPending){this.rebuildPending=!0;var t=this;setTimeout(function(){t.rebuildPending&&(t.rebuildPending=!1,t.emit("rebuild",t))},this.options.minRebuildInterval)}},y.prototype.queueSortPhase=function(){if(!this.sortDirty){this.sortDirty=!0;var t=this;"active"===this.options.sortPriority?setTimeout(function(){t.performSortPhase()},this.options.minRebuildInterval):this.queueRebuildEvent()}},y.prototype.performSortPhase=function(t){(this.sortDirty||this.resultsdirty)&&(t=t||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria&&this.resultset.compoundsort(this.sortCriteria),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),t.suppressRebuildEvent||this.emit("rebuild",this))},y.prototype.evaluateDocument=function(t,e){var i=this.resultset.filteredrows,n=e?-1:i.indexOf(+t),r=i.length,s=new d(this.collection);s.filteredrows=[t],s.filterInitialized=!0;for(var o,a=0,l=this.filterPipeline.length;l>a;a++)o=this.filterPipeline[a],s[o.type](o.val);var h=0===s.filteredrows.length?-1:0;return-1!==n||-1!==h?-1===n&&-1!==h?(i.push(t),this.options.persistent&&this.resultdata.push(this.collection.data[t]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):-1!==n&&-1===h?(r-1>n?(i[n]=i[r-1],i.length=r-1,this.options.persistent&&(this.resultdata[n]=this.resultdata[r-1],this.resultdata.length=r-1)):(i.length=r-1,this.options.persistent&&(this.resultdata.length=r-1)),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):-1!==n&&-1!==h?(this.options.persistent&&(this.resultdata[n]=this.collection.data[t]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):void 0:void 0
},y.prototype.removeDocument=function(t){var e,i=this.resultset.filteredrows,n=i.indexOf(+t),r=i.length;for(-1!==n&&(r-1>n?(i[n]=i[r-1],i.length=r-1,this.options.persistent&&(this.resultdata[n]=this.resultdata[r-1],this.resultdata.length=r-1)):(i.length=r-1,this.options.persistent&&(this.resultdata.length=r-1)),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent()),r=i.length,e=0;r>e;e++)i[e]>t&&i[e]--},y.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(i){throw i}},v.prototype=new u,v.prototype.console={log:function(){},warn:function(){},error:function(){}},v.prototype.addAutoUpdateObserver=function(t){this.autoupdate&&"function"==typeof Object.observe&&Object.observe(t,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])},v.prototype.removeAutoUpdateObserver=function(t){this.autoupdate&&"function"==typeof Object.observe&&Object.unobserve(t,this.observerCallback)},v.prototype.addTransform=function(t,e){if(this.transforms.hasOwnProperty(t))throw new Error("a transform by that name already exists");this.transforms[t]=e},v.prototype.setTransform=function(t,e){this.transforms[t]=e},v.prototype.removeTransform=function(t){delete this.transforms[t]},v.prototype.byExample=function(t){var e,i,n;n=[];for(e in t)t.hasOwnProperty(e)&&n.push((i={},i[e]=t[e],i));return{$and:n}},v.prototype.findObject=function(t){return this.findOne(this.byExample(t))},v.prototype.findObjects=function(t){return this.find(this.byExample(t))},v.prototype.ttlDaemonFuncGen=function(){var t=this,e=this.ttl.age;return function(){var i=Date.now(),n=t.chain().where(function(t){var n=t.meta.updated||t.meta.created,r=i-n;return r>e});n.remove()}},v.prototype.setTTL=function(t,e){0>t?clearInterval(this.ttl.daemon):(this.ttl.age=t,this.ttl.ttlInterval=e,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),e))},v.prototype.prepareFullDocIndex=function(){for(var t=this.data.length,e=new Array(t),i=0;t>i;i+=1)e[i]=i;return e},v.prototype.ensureIndex=function(i,n){if("undefined"==typeof n&&(n=!1),null===i||void 0===i)throw new Error("Attempting to set index without an associated property");if(!this.binaryIndices[i]||n||this.binaryIndices[i].dirty){var r={name:i,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[i]=r;var s=function(i,n){return function(r,s){var o=n[r][i],a=n[s][i];if(o!==a){if(t(o,a,!1))return-1;if(e(o,a,!1))return 1}return 0}}(i,this.data);r.values.sort(s),r.dirty=!1,this.dirty=!0}},v.prototype.getSequencedIndexValues=function(t){var e,i=this.binaryIndices[t].values,n="";for(e=0;e<i.length;e++)n+=" ["+e+"] "+this.data[i[e]][t];return n},v.prototype.ensureUniqueIndex=function(t){var e=this.constraints.unique[t];return e||-1==this.uniqueNames.indexOf(t)&&this.uniqueNames.push(t),this.constraints.unique[t]=e=new q(t),this.data.forEach(function(t){e.set(t)}),e},v.prototype.ensureAllIndexes=function(t){var e,i=this.binaryIndices;for(e in i)$.call(i,e)&&this.ensureIndex(e,t)},v.prototype.flagBinaryIndexesDirty=function(){var t,e=this.binaryIndices;for(t in e)$.call(e,t)&&(e[t].dirty=!0)},v.prototype.flagBinaryIndexDirty=function(t){this.binaryIndices[t]&&(this.binaryIndices[t].dirty=!0)},v.prototype.count=function(t){return t?this.chain().find(t).filteredrows.length:this.data.length},v.prototype.ensureId=function(){var t=this.data.length,e=0;for(this.idIndex=[],e;t>e;e+=1)this.idIndex.push(this.data[e].$loki)},v.prototype.ensureIdAsync=function(t){this.async(function(){this.ensureId()},t)},v.prototype.addDynamicView=function(t,e){var i=new y(this,t,e);return this.DynamicViews.push(i),i},v.prototype.removeDynamicView=function(t){for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].name===t&&this.DynamicViews.splice(e,1)},v.prototype.getDynamicView=function(t){for(var e=0;e<this.DynamicViews.length;e++)if(this.DynamicViews[e].name===t)return this.DynamicViews[e];return null},v.prototype.findAndUpdate=function(t,e){var i,n=this.where(t),r=0;try{for(r;r<n.length;r++)i=e(n[r]),this.update(i)}catch(s){this.rollback(),this.console.error(s.message)}},v.prototype.insert=function(t){if(!Array.isArray(t))return this.insertOne(t);for(var e,i=[],n=0,r=t.length;r>n;n++){if(e=this.insertOne(t[n]),!e)return void 0;i.push(e)}return 1===i.length?i[0]:i},v.prototype.insertOne=function(t){var e=null;if("object"!=typeof t?e=new TypeError("Document needs to be an object"):null===t&&(e=new TypeError("Object cannot be null")),null!==e)throw this.emit("error",e),e;var i=this.cloneObjects?a(t,this.cloneMethod):t;return"undefined"==typeof i.meta&&(i.meta={revision:0,created:0}),this.emit("pre-insert",i),this.add(i)?(this.addAutoUpdateObserver(i),this.emit("insert",i),i):void 0},v.prototype.clear=function(){this.data=[],this.idIndex=[],this.binaryIndices={},this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0},v.prototype.update=function(t){if(this.flagBinaryIndexesDirty(),Array.isArray(t)){var e=0,i=t.length;for(e;i>e;e+=1)this.update(t[e])}else{if(!$.call(t,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();var n,r,s=this.get(t.$loki,!0),o=this;if(n=s[0],r=s[1],!s)throw new Error("Trying to update a document not in collection.");this.emit("pre-update",t),Object.keys(this.constraints.unique).forEach(function(e){o.constraints.unique[e].update(t)}),this.data[r]=t,n!==t&&this.addAutoUpdateObserver(t);for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].evaluateDocument(r,!1);return this.idIndex[r]=n.$loki,this.commit(),this.dirty=!0,this.emit("update",t),t}catch(l){throw this.rollback(),this.console.error(l.message),this.emit("error",l),l}}},v.prototype.add=function(t){if("object"!=typeof t)throw new TypeError("Object being added needs to be an object");if("undefined"!=typeof t.$loki)throw new Error("Document is already in collection, please use update()");this.flagBinaryIndexesDirty();try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1),t.$loki=this.maxId,t.meta.version=0;var e,i=this.constraints.unique;for(e in i)$.call(i,e)&&i[e].set(t);this.idIndex.push(t.$loki),this.data.push(t);for(var n=this.data.length-1,r=this.DynamicViews.length,s=0;r>s;s++)this.DynamicViews[s].evaluateDocument(n,!0);return this.commit(),this.dirty=!0,this.cloneObjects?a(t,this.cloneMethod):t}catch(o){throw this.rollback(),this.console.error(o.message),this.emit("error",o),o}},v.prototype.removeWhere=function(t){var e;e="function"==typeof t?this.data.filter(t):new d(this,{queryObj:t}),this.remove(e)},v.prototype.removeDataOnly=function(){this.remove(this.data.slice())},v.prototype.remove=function(t){if("number"==typeof t&&(t=this.get(t)),"object"!=typeof t)throw new Error("Parameter is not an object");if(Array.isArray(t)){var e=0,i=t.length;for(e;i>e;e+=1)this.remove(t[e])}else{if(!$.call(t,"$loki"))throw new Error("Object is not a document stored in the collection");this.flagBinaryIndexesDirty();try{this.startTransaction();var n=this.get(t.$loki,!0),r=n[1],s=this;Object.keys(this.constraints.unique).forEach(function(e){null!==t[e]&&"undefined"!=typeof t[e]&&s.constraints.unique[e].remove(t[e])});for(var o=0;o<this.DynamicViews.length;o++)this.DynamicViews[o].removeDocument(r);return this.data.splice(r,1),this.removeAutoUpdateObserver(t),this.idIndex.splice(r,1),this.commit(),this.dirty=!0,this.emit("delete",n[0]),delete t.$loki,delete t.meta,t}catch(a){return this.rollback(),this.console.error(a.message),this.emit("error",a),null}}},v.prototype.get=function(t,e){var i=e||!1,n=this.idIndex,r=n.length-1,s=0,o=s+r>>1;if(t="number"==typeof t?t:parseInt(t,10),isNaN(t))throw new TypeError("Passed id is not an integer");for(;n[s]<n[r];)o=s+r>>1,n[o]<t?s=o+1:r=o;return r===s&&n[s]===t?i?[this.data[s],s]:this.data[s]:null},v.prototype.by=function(t,e){var i;if(void 0===e)return i=this,function(e){return i.by(t,e)};var n=this.constraints.unique[t].get(e);return this.cloneObjects?a(n,this.cloneMethod):n},v.prototype.findOne=function(t){var e=new d(this,{queryObj:t,firstOnly:!0});return Array.isArray(e)&&0===e.length?null:this.cloneObjects?a(e,this.cloneMethod):e},v.prototype.chain=function(t,e){var i=new d(this);return"undefined"==typeof t?i:i.transform(t,e)},v.prototype.find=function(t){"undefined"==typeof t&&(t="getAll");var e=new d(this,{queryObj:t});return this.cloneObjects?l(e,this.cloneMethod):e},v.prototype.findOneUnindexed=function(t,e){for(var i,n=this.data.length;n--;)if(this.data[n][t]===e)return i=this.data[n];return null},v.prototype.startTransaction=function(){if(this.transactional){this.cachedData=a(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].startTransaction()}},v.prototype.commit=function(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].commit()}},v.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex);for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].rollback()}},v.prototype.async=function(t,e){setTimeout(function(){if("function"!=typeof t)throw new TypeError("Argument passed for async execution is not a function");t(),e()},0)},v.prototype.where=function(t){var e=new d(this,{queryFunc:t});return this.cloneObjects?l(e,this.cloneMethod):e},v.prototype.mapReduce=function(t,e){try{return e(this.data.map(t))}catch(i){throw i}},v.prototype.eqJoin=function(t,e,i,n){return new d(this).eqJoin(t,e,i,n)},v.prototype.stages={},v.prototype.getStage=function(t){return this.stages[t]||(this.stages[t]={}),this.stages[t]},v.prototype.commitLog=[],v.prototype.stage=function(t,e){var i=JSON.parse(JSON.stringify(e));return this.getStage(t)[e.$loki]=i,i},v.prototype.commitStage=function(t,e){var i,n=this.getStage(t),r=(new Date).getTime();for(i in n)this.update(n[i]),this.commitLog.push({timestamp:r,message:e,data:JSON.parse(JSON.stringify(n[i]))});this.stages[t]={}},v.prototype.no_op=function(){},v.prototype.extract=function(t){var e=0,i=this.data.length,n=g(t),r=[];for(e;i>e;e+=1)r.push(x(this.data[e],t,n));return r},v.prototype.max=function(t){return Math.max.apply(null,this.extract(t))},v.prototype.min=function(t){return Math.min.apply(null,this.extract(t))},v.prototype.maxRecord=function(t){var e,i=0,n=this.data.length,r=g(t),s={index:0,value:void 0};for(i;n>i;i+=1)void 0!==e?e<x(this.data[i],t,r)&&(e=x(this.data[i],t,r),s.index=this.data[i].$loki):(e=x(this.data[i],t,r),s.index=this.data[i].$loki);return s.value=e,s},v.prototype.minRecord=function(t){var e,i=0,n=this.data.length,r=g(t),s={index:0,value:void 0};for(i;n>i;i+=1)void 0!==e?e>x(this.data[i],t,r)&&(e=x(this.data[i],t,r),s.index=this.data[i].$loki):(e=x(this.data[i],t,r),s.index=this.data[i].$loki);return s.value=e,s},v.prototype.extractNumerical=function(t){return this.extract(t).map(m).filter(Number).filter(function(t){return!isNaN(t)})},v.prototype.avg=function(t){return I(this.extractNumerical(t))},v.prototype.stdDev=function(t){return O(this.extractNumerical(t))},v.prototype.mode=function(t){var e={},i=this.extract(t);i.forEach(function(t){e[t]?e[t]+=1:e[t]=1});var n,r,s;for(r in e)n?n<e[r]&&(s=r):(s=r,n=e[r]);return s},v.prototype.median=function(t){var e=this.extractNumerical(t);e.sort(b);var i=Math.floor(e.length/2);return e.length%2?e[i]:(e[i-1]+e[i])/2},A.prototype={keys:[],values:[],sort:function(t,e){return e>t?-1:t>e?1:0},setSort:function(t){this.bs=new k(t)},bs:function(){return new k(this.sort)},set:function(t,e){var i=this.bs(this.keys,t);i.found?this.values[i.index]=e:(this.keys.splice(i.index,0,t),this.values.splice(i.index,0,e))},get:function(t){return this.values[D(this.keys,t,this.sort).index]}},q.prototype.keyMap={},q.prototype.lokiMap={},q.prototype.set=function(t){var e=t[this.field];if(null!==e&&"undefined"!=typeof e){if(this.keyMap[e])throw new Error("Duplicate key for property "+this.field+": "+e);this.keyMap[e]=t,this.lokiMap[t.$loki]=e}},q.prototype.get=function(t){return this.keyMap[t]},q.prototype.byId=function(t){return this.keyMap[this.lokiMap[t]]},q.prototype.update=function(t){if(this.lokiMap[t.$loki]!==t[this.field]){var e=this.lokiMap[t.$loki];this.set(t),this.keyMap[e]=void 0}else this.keyMap[t[this.field]]=t},q.prototype.remove=function(t){var e=this.keyMap[t];if(null===e||"undefined"==typeof e)throw new Error("Key is not in unique index: "+this.field);this.keyMap[t]=void 0,this.lokiMap[e.$loki]=void 0},q.prototype.clear=function(){this.keyMap={},this.lokiMap={}},P.prototype={set:function(t,e){this.index[t]?this.index[t].push(e):this.index[t]=[e]},remove:function(t,e){var i=this.index[t];for(var n in i)i[n]==e&&i.splice(n,1);i.length<1&&(this.index[t]=void 0)},get:function(t){return this.index[t]},clear:function(){this.index={}}},C.prototype={keys:[],values:[],sort:function(t,e){return e>t?-1:t>e?1:0},bs:function(){return new k(this.sort)},setSort:function(t){this.bs=new k(t)},set:function(t,e){var i=D(this.keys,t,this.sort);i.found?this.values[i.index].push(e):(this.keys.splice(i.index,0,t),this.values.splice(i.index,0,[e]))},get:function(t){var e=D(this.keys,t,this.sort);return e.found?this.values[e.index]:[]},getLt:function(t){var e=D(this.keys,t,this.sort),i=e.index;return e.found&&i--,this.getAll(t,0,i)},getGt:function(t){var e=D(this.keys,t,this.sort),i=e.index;return e.found&&i++,this.getAll(t,i,this.keys.length)},getAll:function(t,e,i){for(var n=[],r=e;i>r;r++)n=n.concat(this.values[r]);return n},getPos:function(t){return D(this.keys,t,this.sort)},remove:function(t,e){var i=D(this.keys,t,this.sort).index,n=this.values[i];for(var r in n)n[r]==e&&n.splice(r,1);n.length<1&&(this.keys.splice(i,1),this.values.splice(i,1))},clear:function(){this.keys=[],this.values=[]}},c.LokiOps=S,c.Collection=v,c.KeyValueStore=A,c.persistenceAdapters={fs:f,localStorage:p},c}()});