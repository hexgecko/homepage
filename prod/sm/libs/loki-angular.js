!function(n,e){"function"==typeof define&&define.amd?define(["angular","lokijs"],e):"object"==typeof exports?module.exports=e():n.lokiAngular=e(n.angular,n.thirdParty&&n.thirdParty.loki?n.thirdParty.loki:n.loki)}(this,function(n){function e(){return loki}function o(e,o,t){function c(){return z}function i(n){localStorage.removeItem(n)}function r(n,e,t){return o(function(o,c){A=n,g("delete_doc",n,e,t).then(function(n){z={},o(n)},function(n){c(n)})})}function a(n){return o(function(e,o){g("insert_item_in_doc",z.dbName,z.collName,z.doc,"",n).then(function(n){e(n)},function(n){o(n)})})}function u(){return o(function(n,e){g("delete_current_doc").then(function(e){n(e)},function(n){e(n)})})}function l(n,e,t){return o(function(o,c){A=n,g("create_doc",n,e,"","",t).then(function(t){z.dbName=n,z.collName=e,z.doc=t,z.lokiNum=t[0].$loki,o(t[0])},function(n){c(n)})})}function f(n,e,t){return o(function(o,c){A=n,g("set_doc",n,e,t).then(function(t){z.dbName=n,z.collName=e,z.doc=t,z.lokiNum=t[0].$loki,o(t[0])},function(n){c(n)})})}function d(n,e){return o(function(o,t){z?g("update_current_doc",z.dbName,z.collName,z.doc,n,e).then(function(n){o(n[0])},function(n){t(n)}):t("you have to set a current doc first, use: setCurrentDoc(dbName, collName, docName)")})}function s(n,e,t,c,i){return o(function(o,r){A=n,z?g("update_doc",n,e,t,c,i).then(function(n){o(n[0])},function(n){r(n)}):r("bad, check parameters)")})}function v(n,e,t){return o(function(o,c){A=n,g("get_doc",n,e,t).then(function(t){z.dbName=n,z.collName=e,z.doc=t,z.lokiNum=t[0].$loki,o(t[0])},function(n){c(n)})})}function m(n,e){return o(function(o,t){A=n,g("get_collection",n,e).then(function(t){B.dbName=n,B.collName=e,o(t)},function(n){t(n)})})}function h(n,e){return o(function(o,t){A=n,g("remove_collection",n,e).then(function(n){B={},o(n)},function(n){t(n)})})}function _(n){return o(function(e,o){var t=J(n);A=n[t.db],g("add_collection",A,"","","",n).then(function(n){B.dbName=A,e(n)},function(n){o(n)})})}function g(e,t,c,i,r,a){return o(function(o,u){function l(){var l;if("update_doc"===e||"insert_item_in_doc"===e){P.loadDatabase(t);var f=P.getCollection(c);for(var d in i)z.key=d,z.value=i[d];for(var s=0;s<f.data.length;s++)f.data[s][z.key]===z.value&&(z.lokiNum=f.data[s].$loki);l=f.get(parseInt(z.lokiNum,10)),"update_doc"===e?(l[r]=a,f.update(l)):l.insert(a),P.save(),o(!0)}else if("update_current_doc"===e){P.loadDatabase(t);var v=P.getCollection(c);l=v.get(parseInt(z.lokiNum,10)),l[r]=a,v.update(l),P.save(),o(!0)}else if("delete_current_doc"===e||"delete_doc"===e){P.loadDatabase(t);var m=P.getCollection(c);if("delete_doc"===e){for(var h in i)z.key=h,z.value=i[h];for(var _=0;_<m.data.length;_++)m.data[_][z.key]===z.value&&(z.lokiNum=m.data[_].$loki)}m.remove(z.lokiNum),P.save(),o(!0)}else if("get_doc"===e||"set_doc"===e){P.loadDatabase(t);var g=P.getCollection(c);l=g.find(i),o(n.fromJson(l))}else if("get_collection"===e){P.loadDatabase(t);var k=P.getCollection(c);o(n.fromJson(k))}else if("remove_collection"===e)P.loadDatabase(t),P.removeCollection(c),P.save(function(){o("collection deleted")});else if("add_collection"===e){P.loadDatabase(t);for(var b=J(a),N=0;N<b.coll_array.length;N++){var p=P.addCollection(a[b.coll_array[N].coll]);p.insert(a[b.coll_array[N].docs])}P.save(function(){o("collection(s) added")})}else if("create_doc"===e){P.loadDatabase(t);var y=P.getCollection(c);y.insert(a),P.save(function(){var e=y.find({name:a.name});o(n.fromJson(e))})}else if("delete_current_doc"===e){var D=P.getCollection(z.collName);D?(D.remove(parseInt(z.lokiNum,10)),P.save(),o(!0)):u("You forgot to specify a current doc first")}}P?P.filename===t?l():I(t).then(function(){l()}):S?I(t).then(function(){l()}):p().then(function(){l()},function(n){u(n)})})}function k(n){var e=window.localStorage.getItem(n);return e?!0:!1}function b(){return o(function(n){for(var e=0,o=0;o<Y.length;o++)e++,Y[o].close(),o===Y.length-1&&n()})}function N(n){return o(function(e){for(var o=0;o<Y.length;o++)if(Y.filename===n){Y[o].close(),e();break}})}function p(){return o(function(n,e){0===O.length?j().then(function(){S=!0,n()},function(n){e(n)}):n()})}function y(){return o(function(n){for(var e=0;e>=0;e++){if(!t.has("json"+(e+1))){n();break}var o={},c=t.get("json"+(e+1)),i=J(c);c[i.db]===A?(q=e+1,e===E-1&&n()):(o.filename=i.db,o.json=e+1,O.push(o),e===E-1&&n())}})}function D(){return o(function(n,e){y().then(function(){0===q&&e("Oops!, you didn't specify any starting document");var o=t.get("json"+q),c={},i=J(o);c.filename=i.db,c.json=q,O.push(c),n()})})}function C(){if(E>=1)return E;for(var n=0;n>=0&&t.has("json"+(n+1));n++)E++;return E}function j(){return o(function(e,o){D().then(function(){function o(){if(t.has("json"+O[G-1].json)){var c=t.get("json"+O[G-1].json),i=n.fromJson(c);F=!0,w(i).then(function(){return $(P.filename)||Y.push(n.copy(P)),F=!1,G!==O.length?(G++,void o()):void e()})}}o()},function(n){o(n)})})}function $(n){for(var e=!1,o=0;o<Y.length;o++)Y[o].filename===n&&(e=!0);return e}function I(n){return o(function(e){for(var o=0;o<Y.length;o++)Y[o].filename===n&&(P=Y[o],e())})}function w(n){return o(function(e){function o(){if(c)e();else{for(var o=J(n),t=0;t<o.coll_array.length;t++){var i=P.addCollection(n[o.coll_array[t].coll]);i.insert(n[o.coll_array[t].docs])}P.save(),e()}}var t=J(n),c=!1;k(n[t.db])&&(c=!0),P=new loki(n[t.db],{autoload:!0,autoloadCallback:o,autosave:!0,autosaveInterval:1e4})})}function J(n){var e=1,o="",t="",c="",i=[];for(var r in n){if(e>1)if(x(e))t=r;else{c=r;var a={coll:t,docs:c};i.push(a)}else o=r;e++}var u={db:o,coll_array:i};return u}function x(n){return n%2===0}var L=this;L.checkStates=p;var P,S=!1,A="",q=0,E=0,O=[],Y=[];L.dbExists=k,L.closeDb=N,L.closeAllDbs=b,L.getCollection=m,L.addCollection=_,L.removeCollection=h,L.getDoc=v,L.updateDoc=s,L.updateCurrentDoc=d,L.setCurrentDoc=f,L.getCurrentDoc=c,L.deleteDocument=r,L.deleteCurrentDoc=u,L.deleteDatabase=i,L.addDocument=l,L.insertItemInDoc=a;var z={},B={};E=C();var F=!1,G=1}var t=n.module("lokijs",[]).factory("Loki",e).service("Lokiwork",o);return o.$inject=["Loki","$q","$injector","$window"],t});