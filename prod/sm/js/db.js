angular.module("app.db",["lokijs"]).factory("db",["$q","Loki",function(e,t){var n,a,d,r,i,o,s,u,l,c,f,m,g=0,v=0,p=function(){return void 0!=n?e(function(e){var t=d.find()[0].currentDb,n=a.get(t).filename;e(n)}):(n="undefined"==typeof cordove?new t("setting.loki",{autosave:!0,autosaveInterval:1e3}):new t("setting",{autosave:!0,autosaveInterval:1e3,adapter:new LokiCordovaFSAdapter({prefix:"loki"})}),e(function(e){n.loadDatabase({},function(){a=n.getCollection("filemap_v1"),void 0==a&&(a=n.addCollection("filemap_v1"),a.insert({name:"Default",filename:"db_1"})),d=n.getCollection("setting_v1"),void 0==d&&(d=n.addCollection("setting_v1"),d.insert({uniqueNumber:2,currentDb:a.find({filename:"db_1"})[0].$loki,encrypt:!1}));var t=d.find()[0].currentDb,r=a.get(t).filename;e(r)})}))},I=function(){return e(void 0!=r?function(e){e()}:function(e){p().then(function(n){r="undefined"==typeof cordova?new t(n+".loki",{autosave:!0,autosaveInterval:1e3}):new t(n,{autosave:!0,autosaveInterval:1e3,adapter:new LokiCordovaFSAdapter({prefix:"loki"})}),r.loadDatabase({},function(){i=r.getCollection("class_v2")||r.addCollection("class_v2"),o=r.getCollection("classNote_v1")||r.addCollection("classNote_v1"),s=r.getCollection("student_v2")||r.addCollection("student_v2"),u=r.getCollection("studentClassLink_v2")||r.addCollection("studentClassLink_v2",{indices:["studentId","classId"]}),l=r.getCollection("studentNote_v2")||r.addCollection("studentNote_v2",{indices:["studentId"]}),c=r.getCollection("examGroup_v2")||r.addCollection("examGroup_v2",{indices:["classId"]}),f=r.getCollection("exam_v2")||r.addCollection("exam_v2",{indices:["examGroupId"]}),m=r.getCollection("examGrade_v1")||r.addCollection("examGrade_v1",{indices:["examId","studentId"]}),e()})})})},h=function(){return i.find()},x=function(e){return i.get(e)},C=function(e){i.insert(e)},L=function(e){i.update(e)},k=function(e){for(var t=c.find({classId:e.$loki}),n=0;n<t.length;n++){for(var a=f.find({examGroupId:t[n].$loki}),d=0;d<a.length;d++){for(var r=u.find({classId:e.$loki}),s=0;s<r.length;s++)m.removeWhere({$and:[{examId:a[d].$loki},{studentId:r[s].studentId}]});f.remove(a[d])}c.remove(t[n])}o.removeWhere({classId:e.$loki}),u.removeWhere({classId:e.$loki}),i.remove(e)},N=function(e,t){for(var n=i.insert(t),a=u.find({classId:e}),d=0;d<a.length;d++)u.insert({classId:n.$loki,studentId:a[d].studentId})},S=function(e){return o.chain().find({classId:e}).simplesort("timestamp",!0).data()},G=function(e){return o.get(e)},$=function(e){return o.insert(e)},_=function(e){o.update(e)},w=function(e){o.remove(e)},E=function(e){if(void 0==e)return s.chain().simplesort("lastName").data();for(var t=u.eqJoin(s.data,"studentId","$loki",function(e,t){return{classId:e.classId,studentId:e.studentId,lastName:t.lastName}}),n=t.find({classId:e}).simplesort("lastName").data(),a=new Array(n.length),d=0;d<n.length;d++)a[d]=s.get(n[d].studentId);return a},b=function(e){for(var t=u.find({studentId:e}),n=new Array(t.length),a=0;a<t.length;a++)n[a]=i.get(t[a].classId);return n},y=function(e){return s.chain().find({$or:[{lastName:{$regex:new RegExp(e,"i")}},{firstName:{$regex:new RegExp(e,"i")}}]}).simplesort("lastName").data()},A=function(e){return s.get(e)},W=function(e,t){var n=s.insert(t);return void 0!=e&&u.insert({classId:e,studentId:t.$loki}),g++,n},D=function(e){s.update(e),v++},F=function(e,t){u.removeWhere({$and:[{studentId:e},{classId:t}]})},j=function(e){s.remove(e),l.removeWhere({studentId:e}),m.removeWhere({studentId:e}),u.removeWhere({studentId:e}),g++},q=function(){return v},T=function(){v++},R=function(){return g},V=function(){g++},J=function(e){return u.find({classId:e})},z=function(e){return u.find({studentId:e})},B=function(e,t){u.insert({classId:t,studentId:e.$loki}),v++},H=function(e){return c.get(e)},K=function(e){for(var t=c.find({classId:e}),n=new Array(t.length),a=0;a<t.length;a++){for(var d=Q(t[a].$loki),r=0,i=0;i<d.examList.length;i++){var o=d.examList[i].timestamp;o>r&&(r=o)}n[a]={examGroupId:t[a].$loki,category:t[a].category,examList:d.examList,dateList:d.dateList,weight:t[a].weight,timestamp:r,collapseExamList:t[a].collapseExamList}}return n.sort(function(e,t){return e.timestamp>t.timestamp?-1:1}),n},M=function(e){return v++,c.insert(e)},O=function(e){v++,c.update(e)},P=function(e){c.remove(e)},Q=function(e){for(var t=f.chain().find({examGroupId:e}).simplesort("timestamp",!0).data(),n=new Array(t.length),a=0;a<n.length;a++)n[a]=new Date(t[a].timestamp).toLocaleDateString();return{examList:t,dateList:n}},U=function(e){return f.get(e)},X=function(e){return v++,f.insert(e)},Y=function(e){v++,f.update(e)},Z=function(e){v++,f.remove(e)},et=function(e){return m.find({examId:e})},tt=function(e){v++,m.insert(e)},nt=function(e,t){var n=m.find({$and:[{examId:e},{studentId:t}]});return n[0].grade},at=function(e,t){var n=m.get(e);n.grade=Number(t),m.update(n),v++},dt=function(e,t){m.removeWhere({$and:[{examId:e},{studentId:t}]}),v++},rt=function(e){return l.chain().find({studentId:e}).simplesort("timestamp",!0).data()},it=function(e){return l.get(e)},ot=function(e){return v++,l.insert(e)},st=function(e){v++,l.update(e)},ut=function(e){v++,l.remove(e)},lt=function(e){for(var t=K(e),n=E(e),a=new Array(n.length),d=0;d<n.length;d++){for(var r=n[d],i=0,o=0,s=0;s<t.length;s++){var u=Q(t[s].examGroupId).examList,l=0;i+=Number(t[s].weight);for(var c=0;c<u.length;c++)l+=nt(u[c].$loki,r.$loki);o+=t[s].weight*(l/u.length)}a[d]={lastName:r.lastName,firstName:r.firstName,grade:o/i}}return a};return _getGraderListForStudent=function(e){for(var t=z(e),n=new Array(t.length),a=0;a<t.length;a++){for(var d=x(t[a].classId),r=K(d.$loki),i=0,o=0,s=new Array(r.length),u=0;u<r.length;u++){for(var l=r[u],c=Number(l.weight),f=0,m=Q(l.examGroupId).examList,g=0;g<m.length;g++)f+=nt(m[g].$loki,e);i+=c,o+=c*(f/m.length),s[u]={name:l.name,category:l.category,weight:c,grade:f/m.length}}if(!(r.length>0))return[];n[a]={name:d.name,subject:d.subject,gradeList:s,sumWeight:i,avgGrade:o/i}}return n},{init:I,getClassList:h,getClass:x,addClass:C,updateClass:L,deleteClass:k,cloneClass:N,getClassNoteList:S,getClassNote:G,addClassNote:$,updateClassNote:_,deleteClassNote:w,getStudentList:E,getStudentClassList:b,searchStudentList:y,getStudent:A,addStudent:W,updateStudent:D,removeStudentFromClass:F,deleteStudent:j,getStudentChanged:q,setStudentChanged:T,getStudentListChanged:R,setStudentListChanged:V,getStudentToClassLink:J,getClassToStudentLink:z,linkStudentToClass:B,getExamGroup:H,getExamGroupList:K,addExamGroup:M,updateExamGroup:O,deleteExamGroup:P,getExamList:Q,getExam:U,addExam:X,updateExam:Y,deleteExam:Z,getExamGradeList:et,addExamGrade:tt,getExamGradeValue:nt,updateExamGradeValue:at,deleteExamGrade:dt,getStudentNoteList:rt,getStudentNote:it,addStudentNote:ot,updateStudentNote:st,deleteStudentNote:ut,getGradeListForClass:lt,getGraderListForStudent:_getGraderListForStudent}}]);