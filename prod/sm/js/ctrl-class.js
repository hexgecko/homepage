angular.module("app.classctrl",["app.db"]).controller("classListCtrl",["$scope","$ionicModal","$ionicPlatform","db",function(e,t,a,o){t.fromTemplateUrl("templates/class-modal.html",{scope:e}).then(function(t){e.classAddEditModal=t}),t.fromTemplateUrl("templates/clone-class-modal.html",{scope:e}).then(function(t){e.cloneClassModal=t}),e.state={showEditMode:void 0,markedClasses:new Object},a.ready(function(){o.init().then(function(){e.classList=o.getClassList()})}),e.showClassAddEditModal=function(t,a){a?(t.classId=a.$loki,t.className=a.name,t.classSubject=a.subject,t.newClass=!1):(t.className="",t.classSubject="",t.newClass=!0),e.classAddEditModal.show()},e.updateClassRecord=function(t){var a=o.getClass(t.classId);a.name=t.className,a.subject=t.classSubject,o.updateClass(a),e.classAddEditModal.hide()},e.addClassRecord=function(t){o.addClass({name:t.className,subject:t.classSubject,collapseNoteList:!1,collapseStudentList:!1,collapseExamList:!1,archived:!1}),e.classList=o.getClassList(),e.classAddEditModal.hide()},e.showClassCloneModal=function(t,a){t.srcClassId=a.$loki,t.srcClassName=a.name,t.srcClassSubject=a.subject,t.className="",t.classSubject="",t.newClass=!0,e.cloneClassModal.show()},e.cloneClassRecord=function(t){o.cloneClass(t.srcClassId,{name:t.className,subject:t.classSubject}),e.classList=o.getClassList(),e.cloneClassModal.hide()},e.unmarkAllClasses=function(t){for(var a=0;a<e.classList.length;a++)t.markedClasses[a.toString()]=!1},e.deleteSelectedClasses=function(t){for(var a in t.markedClasses)if(t.markedClasses[a]===!0){t.markedClasses[a]=void 0;var s=Number(a),d=e.classList[s];o.deleteClass(d)}e.classList=o.getClassList()},e.toggleShowEditMode=function(t){t.showEditMode=t.showEditMode?!1:!0;for(var a=0;a<e.classList.length;a++)t.markedClasses[a.toString()]=!1},e.$on("$destroy",function(){e.classAddEditModal.remove(),e.$scope.cloneClassModal.remove()})}]).controller("classInfoCtrl",["$scope","$ionicModal","$stateParams","$ionicPlatform","db",function(e,t,a,o,s){t.fromTemplateUrl("templates/class-note-modal.html",{scope:e}).then(function(t){e.noteAddEditModal=t}),t.fromTemplateUrl("templates/student-modal.html",{scope:e}).then(function(t){e.studentAddEditModal=t}),t.fromTemplateUrl("templates/pick-student-modal.html",{scope:e}).then(function(t){e.studentPickModal=t}),t.fromTemplateUrl("templates/exam-item-modal.html",{scope:e}).then(function(t){e.examItemAddEditModal=t}),t.fromTemplateUrl("templates/exam-attach-modal.html",{scope:e}).then(function(t){e.examAttachModal=t}),t.fromTemplateUrl("templates/exam-group-modal.html",{scope:e}).then(function(t){e.examGroupModal=t}),t.fromTemplateUrl("templates/exam-edit-modal.html",{scope:e}).then(function(t){e.examEditModal=t}),e.state={classId:Number(a.classId),showStudentEditMode:void 0,showExamEditMode:void 0,showNoteEditMode:void 0,markedStudents:new Object,markedExamGroups:new Object,markedNotes:new Object,collapseNameForm:!1,collapseGenderForm:!0,collapseContactForm:!0,collapseAddressForm:!0,studentPickSearch:""};var d=function(e){for(var t=new Array(e.length),a=0;a<e.length;a++)t[a]={date:new Date(e[a].timestamp).toLocaleDateString()};return t};o.ready(function(){s.init().then(function(){e.classRecord=s.getClass(e.state.classId),e.noteList=s.getClassNoteList(e.state.classId),e.noteDateList=d(e.noteList),e.studentList=s.getStudentList(e.state.classId),e.examGroupList=s.getExamGroupList(e.state.classId),e.state.markedExams=new Array(e.examGroupList.length);for(var t=0;t<e.examGroupList.length;t++)e.state.markedExams[t]=new Object;e.$watch(function(){return s.getStudentListChanged()},function(){e.studentList=s.getStudentList(e.state.classId)})})}),e.collapseNoteList=function(e){e.collapseNoteList=!e.collapseNoteList,s.updateClass(e)},e.showNoteAddEditModal=function(t,a){a?(t.noteId=a.$loki,t.noteCategory=a.category,t.noteDate=new Date(a.timestamp),t.noteComment=a.comment,t.newNote=!1):(t.noteCategory="Homework",t.noteComment="",t.noteDate=new Date,t.newNote=!0),e.noteAddEditModal.show()},e.addNoteRecord=function(t){s.addClassNote({classId:t.classId,category:t.noteCategory,timestamp:t.noteDate.getTime(),comment:t.noteComment}),e.noteList=s.getClassNoteList(t.classId),e.noteDateList=d(e.noteList),e.noteAddEditModal.hide()},e.updateNoteRecord=function(t){var a=s.getClassNote(t.noteId);a.category=t.noteCategory,a.timestamp=t.noteDate.getTime(),a.comment=t.noteComment,s.updateClassNote(a),e.noteDateList=d(e.noteList),e.noteAddEditModal.hide()},e.unmarkAllNotes=function(t){for(var a=0;a<e.noteList.length;a++)t.markedNotes[a.toString()]=!1},e.deleteSelectedNotes=function(t){for(var a in t.markedNotes)if(t.markedNotes[a]===!0){t.markedNotes[a]=void 0;var o=Number(a),n=e.noteList[o];s.deleteClassNote(n)}e.noteList=s.getClassNoteList(t.classId),e.noteDateList=d(e.noteList)},e.collapseStudentList=function(e){e.collapseStudentList=!e.collapseStudentList,s.updateClass(e)},e.collapseExamGroupList=function(e){e.collapseExamGroupList=!e.collapseExamGroupList,s.updateClass(e)},e.toggleCollapseExamList=function(e){e.collapseExamList=!e.collapseExamList;var t=s.getExamGroup(e.examGroupId);t.collapseExamList=e.collapseExamList,s.updateExamGroup(t)},e.collapseNameForm=function(e){e.collapseNameForm=!1,e.collapseGenderForm=!0,e.collapseContactForm=!0,e.collapseAddressForm=!0},e.collapseGenderForm=function(e){e.collapseNameForm=!0,e.collapseGenderForm=!1,e.collapseContactForm=!0,e.collapseAddressForm=!0},e.collapseContactForm=function(e){e.collapseNameForm=!0,e.collapseGenderForm=!0,e.collapseContactForm=!1,e.collapseAddressForm=!0},e.collapseAddressForm=function(e){e.collapseNameForm=!0,e.collapseGenderForm=!0,e.collapseContactForm=!0,e.collapseAddressForm=!1},e.showStudentAddEditModal=function(t,a){a?(t.studentId=a.$loki,t.studentFirstName=a.firstName,t.studentLastName=a.lastName,t.studentGender=a.gender,t.studentEmail=a.email,t.studentHomePhoneNumber=a.homePhoneNumber,t.studentMobilePhoneNumber=a.mobilePhoneNumber,t.studentStreet=a.street,t.studentCity=a.city,t.studentPostalCode=a.postalCode,t.newStudent=!1):(t.studentFirstName="",t.studentLastName="",t.studentGender="Male",t.studentEmail="",t.studentHomePhoneNumber="",t.studentMobilePhoneNumber="",t.studentStreet="",t.studentCity="",t.studentPostalCode="",t.newStudent=!0),t.collapseNameForm=!1,t.collapseGenderForm=!0,t.collapseContactForm=!0,t.collapseAddressForm=!0,e.studentAddEditModal.show()},e.showStudentPickModal=function(t){t.studentPickSearch="",t.studentPickList=s.searchStudentList(t.studentPickSearch),e.studentPickModal.show()},e.onPickSearchChange=function(e){e.studentPickList=s.searchStudentList(e.studentPickSearch)},e.studentPicked=function(t,a){s.linkStudentToClass(a,t.classId);for(var o=0;o<e.examGroupList.length;o++)for(var d=s.getExamList(e.examGroupList[o].examGroupId).examList,n=0;n<d.length;n++)s.addExamGrade({examId:d[n].$loki,studentId:a.$loki,system:"0-15",grade:0/0});e.studentList=s.getStudentList(t.classId),e.studentPickModal.hide()},e.addStudentRecord=function(t){for(var a=s.addStudent(t.classId,{firstName:t.studentFirstName,lastName:t.studentLastName,gender:t.studentGender,email:t.studentEmail,homePhoneNumber:t.studentHomePhoneNumber,mobilePhoneNumber:t.studentMobilePhoneNumber,street:t.studentStreet,city:t.studentCity,postalCode:t.studentPostalCode,collapseNoteList:!1,archived:!1}),o=0;o<e.examGroupList.length;o++)for(var d=s.getExamList(e.examGroupList[o].examGroupId).examList,n=0;n<d.length;n++)s.addExamGrade({examId:d[n].$loki,studentId:a.$loki,system:"0-15",grade:0/0});e.studentList=s.getStudentList(t.classId),e.studentAddEditModal.hide()},e.updateStudentRecord=function(t){var a=s.getStudent(t.studentId);a.firstName=t.studentFirstName,a.lastName=t.studentLastName,a.gender=t.studentGender,a.email=t.studentEmail,a.homePhoneNumber=t.studentHomePhoneNumber,a.mobilePhoneNumber=t.studentMobilePhoneNumber,a.street=t.studentStreet,a.city=t.studentCity,a.postalCode=t.studentPostalCode,s.updateStudent(a),e.studentList=s.getStudentList(t.classId),e.studentAddEditModal.hide()},e.unmarkAllStudents=function(t){for(var a=0;a<e.studentList.length;a++)t.markedStudents[a.toString()]=!1},e.deleteSelectedStudents=function(t){for(var a in t.markedStudents)if(t.markedStudents[a]===!0){t.markedStudents[a]=void 0;for(var o=Number(a),d=e.studentList[o],n=0;n<e.examGroupList.length;n++)for(var r=s.getExamList(e.examGroupList[n].examGroupId).examList,m=0;m<r.length;m++)s.deleteExamGrade(r[m].$loki,d.$loki);s.removeStudentFromClass(d.$loki,e.state.classId)}e.studentList=s.getStudentList(t.classId)},e.showExamItemAddModal=function(t){t.examName="",t.examDate=new Date,t.examGroupCategory="Test",t.examGroupWeight=50,t.newExamItem=!0,e.examItemAddEditModal.show()},e.showExamGroupEditModal=function(t,a){t.examGroupId=a.examGroupId,t.examGroupCategory=a.category,t.examGroupWeight=a.weight,e.examGroupModal.show()},e.updateExamGroupRecord=function(t){var a=s.getExamGroup(t.examGroupId);a.classId=t.classId,a.category=t.examGroupCategory,a.weight=t.examGroupWeight,s.updateExamGroup(a),e.examGroupList=s.getExamGroupList(t.classId),e.examGroupModal.hide()},e.showExamAttachModal=function(t,a){t.examGroupId=a.examGroupId,t.examName="",t.examDate=new Date,e.examAttachModal.show()},e.showExamEditModal=function(t,a){t.examId=a.$loki,t.examName=a.name,t.examDate=new Date(a.timestamp),e.examEditModal.show()},e.updateExamRecord=function(t){var a=s.getExam(t.examId);a.name=t.examName,a.timestamp=t.examDate.getTime(),s.updateExam(a),e.examGroupList=s.getExamGroupList(t.classId),e.examEditModal.hide()},e.addExamItemRecord=function(t){for(var a=s.addExamGroup({classId:t.classId,category:t.examGroupCategory,weight:Number(t.examGroupWeight),collapseExamList:!1,archived:!1}),o=s.addExam({examGroupId:a.$loki,name:t.examName,timestamp:new Date(t.examDate).getTime()}),d=0;d<e.studentList.length;d++)s.addExamGrade({examId:o.$loki,studentId:e.studentList[d].$loki,system:"15-0",grade:0/0});t.markedExams.push(new Object),e.examGroupList=s.getExamGroupList(t.classId),e.examItemAddEditModal.hide()},e.updateExamItemRecord=function(t){var a=s.getExamGroup(t.examGroupId);a.category=t.examGroupCategory,a.weight=Number(t.examGroupWeight),s.updateExamGroup(a);var o=s.getExam(t.examId);o.name=t.examName,o.timestamp=new Date(t.examDate).getTime(),s.updateExam(o),e.examGroupList=s.getExamGroupList(t.classId),e.examItemAddEditModal.hide()},e.addExamRecord=function(t){for(var a=s.addExam({examGroupId:t.examGroupId,name:t.examName,timestamp:new Date(t.examDate).getTime()}),o=0;o<e.studentList.length;o++)s.addExamGrade({examId:a.$loki,studentId:e.studentList[o].$loki,system:"15-0",grade:0/0});e.examGroupList=s.getExamGroupList(t.classId),e.examAttachModal.hide()},e.unmarkAllExams=function(t){for(var a=0;a<e.examGroupList.length;a++){t.markedExamGroups[a.toString()]=!1;for(var o=0;o<t.markedExams.length;o++)for(var s in t.markedExams[o])t.markedExams[o][s]=!1}},e.deleteSelectedExamGroups=function(t){for(var a in t.markedExamGroups)if("undefined"!=t.markedExamGroups[a]){var o=Number(a),d=e.examGroupList[o];for(var n in t.markedExams[o]){var r=Number(n);if(t.markedExams[o][n]===!0){t.markedExams[o][n]="undefined";for(var m=d.examList[r],i=0;i<e.studentList.length;i++)s.deleteExamGrade(m.$loki,e.studentList[i].$loki);s.deleteExam(m.$loki)}}d&&0==s.getExamList(d.examGroupId).examList.length&&(t.markedExamGroups[a]=!0)}for(var a in t.markedExamGroups)if("undefined"!=t.markedExamGroups[a]){var o=Number(a),d=e.examGroupList[o];if(t.markedExamGroups[a]===!0){t.markedExamGroups[a]="undefined";for(var l=s.getExamList(d.examGroupId).examList,i=0;i<l.length;i++){for(var u=0;u<e.studentList.length;u++)s.deleteExamGrade(l[i].$loki,e.studentList[u].$loki);s.deleteExam(l[i])}s.deleteExamGroup(d.examGroupId)}}e.examGroupList=s.getExamGroupList(t.classId);for(var i=0;i<e.examGroupList.length;i++){t.markedExamGroups[i.toString()]=!1;for(var u=0;u<t.markedExams.length;u++)for(var n in t.markedExams[u])t.markedExams[u][n]=!1}},e.toggleShowEditMode=function(t){t.showNoteEditMode?e.toggleShowNoteEditMode(t):t.showStudentEditMode?e.toggleShowStudentEditMode(t):e.toggleShowExamEditMode(t)},e.toggleShowNoteEditMode=function(t){t.showNoteEditMode?t.showNoteEditMode=!1:(t.showNoteEditMode=!0,t.showStudentEditMode=!1,t.showExamEditMode=!1);for(var a=0;a<e.noteList.length;a++)t.markedNotes[a.toString()]=!1},e.toggleShowStudentEditMode=function(t){t.showStudentEditMode?t.showStudentEditMode=!1:(t.showNoteEditMode=!1,t.showStudentEditMode=!0,t.showExamEditMode=!1);for(var a=0;a<e.studentList.length;a++)t.markedStudents[a.toString()]=!1},e.toggleShowExamEditMode=function(t){t.showExamEditMode?t.showExamEditMode=!1:(t.showNoteEditMode=!1,t.showStudentEditMode=!1,t.showExamEditMode=!0);for(var a=0;a<e.examGroupList.length;a++){t.markedExamGroups[a.toString()]=!1;for(var o=0;o<t.markedExams.length;o++)for(var s in t.markedExams[o])t.markedExams[o][s]=!1}},e.filterStudentAlreadyAdded=function(t){for(var a=0;a<e.studentList.length;a++)if(e.studentList[a].$loki==t.$loki)return!1;return!0},e.$on("$destroy",function(){e.noteAddEditModal.remove(),e.studentAddEditModal.remove(),e.studentPickModal.remove(),e.examItemAddEditModal.remove(),e.examAttachModal.remove(),e.examGroupModal.remove(),e.examEditModal.remove()}),e.keyPressed=function(e){13==e.keyCode&&"undefined"!=typeof cordova&&cordova.plugins.Keyboard.close()}}]).filter("validGrade",function(){return function(e){return isNaN(e)||0>e?"n/a":e.toFixed(0)}}).controller("classReportCtrl",["$scope","$stateParams","$ionicPlatform","db",function(e,t,a,o){e.state={classId:Number(t.classId)},a.ready(function(){o.init().then(function(){e.classRecord=o.getClass(e.state.classId),e.gradeList=o.getGradeListForClass(e.state.classId)})})}]).controller("studentInfoCtrl",["$scope","$ionicModal","$stateParams","$ionicPlatform","$ionicHistory","db",function(e,t,a,o,s,d){t.fromTemplateUrl("templates/student-note-modal.html",{scope:e}).then(function(t){e.noteAddEditModal=t}),e.state={showEditMode:void 0,studentId:Number(a.studentId),markedNotes:new Object,studentRemoved:!1};var n=function(e){for(var t=new Array(e.length),a=0;a<e.length;a++)t[a]={date:new Date(e[a].timestamp).toLocaleDateString()};return t};e.studentRecord={email:"",homePhoneNumber:"",mobilePhoneNumber:"",street:"",city:"",postalCode:""},e.classList=[],o.ready(function(){d.init().then(function(){e.$watch(function(){return d.getStudentChanged()},function(){e.studentRecord=d.getStudent(e.state.studentId),e.noteList=d.getStudentNoteList(e.state.studentId),e.noteDateList=n(e.noteList),e.classGradeList=d.getGraderListForStudent(e.state.studentId),e.classList=d.getStudentClassList(e.state.studentId)}),e.$watch(function(){return d.getStudentListChanged()},function(){void 0==d.getStudent(e.state.studentId)&&(e.state.studentRemoved=!0)})})}),e.$on("$ionicView.enter",function(){1==e.state.studentRemoved&&s.goBack()}),e.collapseNoteList=function(e){e.collapseNoteList=!e.collapseNoteList,d.updateStudent(e)},e.showNoteAddEditModal=function(t,a){a?(t.noteId=a.$loki,t.noteCategory=a.category,t.noteDate=new Date(a.timestamp),t.noteComment=a.comment,e.state.newNote=!1):(t.noteCategory="Unauthorized Absence",t.noteComment="",t.noteDate=new Date,e.state.newNote=!0),e.noteAddEditModal.show()},e.addNoteRecord=function(t){d.addStudentNote({studentId:t.studentId,category:t.noteCategory,timestamp:t.noteDate.getTime(),comment:t.noteComment}),e.noteList=d.getStudentNoteList(t.studentId),e.noteDateList=n(e.noteList),e.noteAddEditModal.hide()},e.updateNoteRecord=function(t){var a=d.getStudentNote(t.noteId);a.category=t.noteCategory,a.timestamp=t.noteDate.getTime(),a.comment=t.noteComment,d.updateStudentNote(a),e.noteDateList=n(e.noteList),e.noteAddEditModal.hide()},e.unmarkAllNotes=function(t){for(var a=0;a<e.noteList.length;a++)t.markedNotes[a.toString()]=!1},e.deleteSelectedNotes=function(t){for(var a in t.markedNotes)if(t.markedNotes[a]===!0){t.markedNotes[a]=void 0;var o=Number(a),s=e.noteList[o];d.deleteStudentNote(s)}e.noteList=d.getStudentNoteList(t.studentId),e.noteDateList=n(e.noteList)},e.toggleShowEditMode=function(t){t.showEditMode=t.showEditMode?!1:!0;for(var a=0;a<e.noteList.length;a++)t.markedNotes[a.toString()]=!1},e.hasContacts=function(e){return""==e.email&&""==e.homePhoneNumber&&""==e.mobilePhoneNumber?!1:!0},e.hasAddress=function(e){return""==e.street&&""==e.city&&""==e.postalCode?!1:!0},e.hasClasses=function(e){return e.length>0},e.$on("$destroy",function(){e.noteAddEditModal.remove()})}]).controller("examInfoCtrl",["$scope","$stateParams","$ionicPlatform","db",function(e,t,a,o){e.state={examId:Number(t.examId)},a.ready(function(){o.init().then(function(){e.examRecord=o.getExam(Number(t.examId)),e.state.examRecordDate=new Date(e.examRecord.timestamp).toLocaleDateString(),e.examGroupRecord=o.getExamGroup(e.examRecord.examGroupId),e.studentGradeList=function(e){for(var t=o.getExamGradeList(e),a=new Array(t.length),s=0;s<t.length;s++){var d=o.getStudent(t[s].studentId);a[s]={examGradeId:t[s].$loki,lastName:d.lastName,firstName:d.firstName,grade:t[s].grade}}return a}(Number(t.examId))})}),e.gradeChanged=function(e){e.gradeUpdated=!0},e.saveExamGrade=function(t){for(var a=0;a<t.length;a++)o.updateExamGradeValue(t[a].examGradeId,t[a].grade);e.state.gradeUpdated=!1}}]);